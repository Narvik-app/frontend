name: Release

on:
  push:
    branches:
      - main
      - '[0-9]+.[0-9]+*'
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    # Only run on a release or pre-release
    if: github.event_name == 'release'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update package.json
        run: |
          VERSION=${{ github.ref_name }}
          VERSION_NUMBER=${VERSION#v}
          jq --indent 2 --arg ver "$VERSION_NUMBER" '.version = $ver' package.json > package.json.tmp && mv package.json.tmp package.json

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "ci: Bump version to ${{ github.ref_name }}"
          branch: main
          file_pattern: package.json

      - name: Upload package.json for build job
        uses: actions/upload-artifact@v6
        with:
          name: package-json
          path: package.json

  build-and-push:
    runs-on: ubuntu-latest
    needs: update-version
    if: success() || needs.update-version.result == 'skipped'
    # This job depends on the update-version job.
    # On a push to main, update-version is skipped, but this job will still run.
    # On a release, this job waits for update-version to succeed.
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download package.json
        if: github.event_name == 'release'
        uses: actions/download-artifact@v7
        with:
          name: package-json
          path: .

      - name: Install Buildah and setup QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | buildah login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin docker.io

      - name: Extract version information
        id: version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          MAJOR=$(echo $VERSION | cut -d. -f1)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          MINOR=$(echo $VERSION | cut -d. -f1-2)
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Determine tags
        id: tags
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/narvik-front"
          TAGS=""
          
          # Always add version tag for releases
          if [ "${{ github.event_name }}" = "release" ]; then
            TAGS="$REPO:${{ steps.version.outputs.version }}"
            
            # Add latest tag for non-prerelease
            if [ "${{ github.event.release.prerelease }}" != "true" ]; then
              TAGS="$TAGS $REPO:latest"
              TAGS="$TAGS $REPO:${{ steps.version.outputs.major }}"
              TAGS="$TAGS $REPO:${{ steps.version.outputs.minor }}"
            fi
          fi
          
          # Add dev tag for main branch pushes
          if [ "${{ github.ref_name }}" = "${{ github.event.repository.default_branch }}" ] && [ "${{ github.event_name }}" != "release" ]; then
            TAGS="$REPO:dev"
          fi
          
          # Add dev-X.X tag for version branches (not main)
          if echo "${{ github.ref_name }}" | grep -qE '^[0-9]+\.[0-9]+'; then
            if [ "${{ github.ref_name }}" != "${{ github.event.repository.default_branch }}" ]; then
              BRANCH_VERSION=$(echo "${{ github.ref_name }}" | grep -oE '^[0-9]+\.[0-9]+[^/]*')
              TAGS="$REPO:dev-$BRANCH_VERSION"
            fi
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build multi-platform images with Buildah
        run: |
          # Create a manifest list with unique name
          MANIFEST_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:temp-manifest-${{ github.sha }}"
          buildah manifest create "$MANIFEST_NAME"
          
          # Build for amd64
          buildah bud \
            --platform linux/amd64 \
            --pull \
            --layers \
            --target run \
            --manifest "$MANIFEST_NAME" \
            --label org.opencontainers.image.vendor="Benoit VIGNAL" \
            --label org.opencontainers.image.url="https://about.narvik.app" \
            --label org.opencontainers.image.source="${{ github.server_url }}/${{ github.repository }}" \
            --label org.opencontainers.image.version="${{ steps.version.outputs.version }}" \
            --label org.opencontainers.image.revision="${{ github.sha }}" \
            --label org.opencontainers.image.created="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            .
          
          # Build for arm64
          buildah bud \
            --platform linux/arm64 \
            --pull \
            --layers \
            --target run \
            --manifest "$MANIFEST_NAME" \
            --label org.opencontainers.image.vendor="Benoit VIGNAL" \
            --label org.opencontainers.image.url="https://about.narvik.app" \
            --label org.opencontainers.image.source="${{ github.server_url }}/${{ github.repository }}" \
            --label org.opencontainers.image.version="${{ steps.version.outputs.version }}" \
            --label org.opencontainers.image.revision="${{ github.sha }}" \
            --label org.opencontainers.image.created="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            .
          
          echo "manifest=$MANIFEST_NAME" >> $GITHUB_OUTPUT
        id: build

      - name: Tag and push multi-platform images
        run: |
          MANIFEST_NAME="${{ steps.build.outputs.manifest }}"
          
          # Tag and push the manifest with all required tags
          for tag in ${{ steps.tags.outputs.tags }}; do
            # Copy the manifest to the target tag
            buildah manifest push --all "$MANIFEST_NAME" "docker://$tag"
          done
          
          # Clean up the temporary manifest
          buildah manifest rm "$MANIFEST_NAME" || true
